<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Veyra — Proof Viewer</title>
<link rel="icon" href="/public/favicon.svg">
<link rel="stylesheet" href="/public/css/globals.css">
<main class="container" style="padding:24px 0">
  <h1 style="color:var(--veyra-primary);font-family:var(--veyra-font-head)">Proof Viewer</h1>
  <p class="muted">Passez un paramètre <code>?id=...</code> pour charger une preuve. <a class="btn-ghost" href="/public/proofs.html">Voir la liste</a></p>
  <div id="box" class="card">En attente d’un ID…</div>
</main>
<script>
function canon(o){
  if(Array.isArray(o)) return o.map(canon);
  if(o && typeof o==='object'){
    const out={}; Object.keys(o).sort().forEach(k=>{ out[k]=canon(o[k]); });
    return out;
  }
  return o;
}
async function sha256Canonical(obj){
  const s = JSON.stringify(canon(obj));
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(s));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function load(){
  const id = new URLSearchParams(location.search).get('id');
  const box = document.getElementById('box');
  if(!id){ box.innerHTML='Aucun ID fourni. Exemple : <code>?id=p_123456789</code>'; return; }
  const r = await fetch('/proofs/'+encodeURIComponent(id));
  if(!r.ok){ box.innerHTML='❌ Preuve introuvable.'; return; }
  const p = await r.json();

  // Recalcule SHA-256 sur une copie **sans** le champ sha256 (comme côté serveur)
  const copy = JSON.parse(JSON.stringify(p)); delete copy.sha256;
  const recalc = await sha256Canonical(copy);
  const ok = (recalc === p.sha256);

  const a = (p.artifacts||[]).map(u=>`<li><a class="btn-ghost" href="${u}" target="_blank">${u.split('/').pop()}</a></li>`).join('') || '<li class="muted">—</li>';

  box.innerHTML = `
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
      <div>
        <div class="mono muted" style="font-size:12px">${new Date(p.timestamp).toLocaleString()}</div>
        <div style="font-weight:700">${p.title||p.id}</div>
        <div class="mono muted" style="font-size:12px">id=${p.id} · kind=${p.kind} · ttv=${p.ttv_sec??'—'}s</div>
      </div>
      <button class="btn-ghost" onclick="navigator.clipboard.writeText('${p.id}')">Copier l’ID</button>
    </div>
    <hr style="border-color:#1f2b2d;opacity:.2;margin:12px 0">
    <div class="card" style="background:#0b1020">
      <div class="mono" style="font-size:12px">sha256 (déclaré) : ${p.sha256}</div>
      <div class="mono" style="font-size:12px">sha256 (recalculé) : ${recalc}</div>
      <div style="margin-top:6px">${ok?'✅ Vérifié (match)':'❌ Mismatch'}</div>
    </div>
    <h3 style="margin-top:16px">Artifacts</h3>
    <ul style="display:flex;gap:10px;flex-wrap:wrap;padding-left:0;list-style:none">${a}</ul>
    <h3 style="margin-top:16px">JSON brut</h3>
    <pre class="mono" style="white-space:pre-wrap;overflow:auto;background:#0b1020;border:1px solid #22333b;border-radius:12px;padding:12px">${JSON.stringify(p,null,2)}</pre>
  `;
}
load();
</script>
