<!doctype html><html lang="fr"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Veyra — Aujourd’hui</title>
<link rel="stylesheet" href="/public/css/globals.css"/>
<link rel="icon" href="/public/favicon.svg" type="image/svg+xml"/>
</head><body>
<main class="container" style="padding:28px 16px">
  <section class="card" style="padding:20px;overflow:hidden">
    <div class="badge">Preuve-ou-rien • Local-first</div>
    <h1 style="font-family:var(--veyra-font-head);font-size:44px;line-height:1.1;margin:10px 0;color:var(--veyra-primary)">
      Veyra le fait.<br/>Vous validez. Preuve à l’arrivée.
    </h1>
    <p class="muted" style="max-width:56ch">OS d’actions prouvées — 1–3 cartes classées, exécution sous caps N0→N3, reçu JSON haché + audit.</p>
    <div style="display:flex;gap:10px;margin-top:14px">
      <a class="btn" href="#today">Voir mes priorités</a>
      <a class="btn-ghost" href="/public/proofs.html">Voir une preuve</a>
    </div>
  </section>

  <section id="proof-sample" class="card" style="margin-top:16px">
    <h3>Preuve réelle (dernière)</h3>
    <div id="last-proof" class="mono" style="font-size:12px;white-space:pre-wrap;background:#0b1020;border:1px solid var(--veyra-slate-700);border-radius:12px;padding:12px;margin-top:8px">Chargement…</div>
    <div style="margin-top:8px;">
      <a id="last-proof-link" class="btn-ghost" href="/public/proofs.html">Ouvrir dans le viewer</a>
    </div>
  </section>

  <section id="today" class="cards" style="margin-top:20px">
    <h2>Aujourd’hui</h2>
    <div id="today-list" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px"></div>
  </section>
</main>

<script src="/public/js/layout.js"></script>
<script src="/public/js/main.js"></script>
<script>
async function loadLastProof(){
  try{
    const list = await getJSON('/proofs');            // attend { items:[id1,id2...] } ou similaire
    const id = (list.items||[]).slice(-1)[0];
    if(!id){ document.getElementById('last-proof').textContent='Aucune preuve pour l’instant.'; return; }
    const p = await (await fetch('/proofs/'+id)).json();
    document.getElementById('last-proof').textContent = JSON.stringify({id:p.id, kind:p.kind, sha256:p.sha256, result:p.result}, null, 2);
    const a = document.getElementById('last-proof-link');
    a.href = '/public/proof.html?id='+encodeURIComponent(id);
  }catch(e){
    document.getElementById('last-proof').textContent='Impossible de charger la preuve : '+e.message;
  }
}

function cardHTML(c){
  const mins = Math.round((c.estimates?.time_min||1));
  const score = (c.score||0).toFixed(2);
  return `
  <div class="card">
    <div class="badge">score ${score} • ~${mins} min</div>
    <h3 style="margin:8px 0 6px 0">${c.title||c.id}</h3>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" data-run="${c.id}">Lancer</button>
      <a class="btn-ghost" href="/public/app.html">Détails</a>
    </div>
  </div>`;
}

async function loadToday(){
  const root = document.getElementById('today-list');
  root.innerHTML = '';
  try{
    const j = await getJSON('/today?n=3');
    (j.priorities||[]).forEach(c => root.appendChild(el(cardHTML(c))));
  }catch(e){
    root.appendChild(el(`<div class="card">Erreur de chargement : ${e.message}</div>`));
  }
  // bind run
  root.querySelectorAll('[data-run]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      btn.disabled = true; const id = btn.getAttribute('data-run');
      try{
        const r = await fetch('/run',{method:'POST',headers:{'Content-Type':'application/json','Idempotency-Key':idk()}, body:JSON.stringify({id})});
        const j = await r.json();
        if(j.proof_id){ location.href = '/public/proof.html?id='+encodeURIComponent(j.proof_id); return; }
        alert('Exécution OK, mais pas de proof_id retourné.');
      }catch(e){ alert('Échec exécution : '+e.message); }
      finally{ btn.disabled = false; }
    });
  });
}

loadToday(); loadLastProof();
</script>
</body></html>
